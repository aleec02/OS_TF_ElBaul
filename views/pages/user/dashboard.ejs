<!-- User Dashboard -->
<section class="py-4">
    <div class="container">
        <!-- Welcome Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h2 mb-1">
                            <i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard
                        </h1>
                        <p class="text-muted mb-0">Bienvenido, <%= user.nombre %> <%= user.apellido %></p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/productos" class="btn btn-outline-primary">
                            <i class="fas fa-search me-2"></i>Explorar Productos
                        </a>
                        <a href="/perfil" class="btn btn-outline-secondary">
                            <i class="fas fa-user-edit me-2"></i>Editar Perfil
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert container -->
        <div id="alerts-container"></div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card bg-primary text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">Mis Favoritos</h6>
                                <h3 class="mb-0" id="favorites-count">-</h3>
                            </div>
                            <div class="fs-1">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-success text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">Mi Carrito</h6>
                                <h3 class="mb-0" id="cart-count">-</h3>
                            </div>
                            <div class="fs-1">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-info text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">Mis Órdenes</h6>
                                <h3 class="mb-0" id="orders-count">-</h3>
                            </div>
                            <div class="fs-1">
                                <i class="fas fa-shopping-bag"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card bg-warning text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title mb-0">Mi Perfil</h6>
                                <h3 class="mb-0">✓</h3>
                            </div>
                            <div class="fs-1">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Quick Actions -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Acciones Rápidas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <a href="/productos" class="btn btn-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <span>Explorar Productos</span>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/favoritos" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                    <i class="fas fa-heart fa-2x mb-2"></i>
                                    <span>Mis Favoritos</span>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/carrito" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                                    <span>Mi Carrito</span>
                                </a>
                            </div>
                            <div class="col-md-6">
                                <a href="/ordenes" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-4">
                                    <i class="fas fa-list fa-2x mb-2"></i>
                                    <span>Mis Órdenes</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Info -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Mi Información
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <i class="fas fa-user fa-2x text-white"></i>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Nombre:</strong>
                            <p class="mb-1"><%= user.nombre %> <%= user.apellido %></p>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong>
                            <p class="mb-1"><%= user.email %></p>
                        </div>
                        <div class="mb-3">
                            <strong>Miembro desde:</strong>
                            <p class="mb-1"><%= new Date(user.fecha_registro).toLocaleDateString('es-PE') %></p>
                        </div>
                        <div class="d-grid">
                            <a href="/perfil" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i>Editar Perfil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Actividad Reciente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity">
                            <div class="text-center py-4">
                                <i class="fas fa-info-circle fa-2x text-muted mb-3"></i>
                                <p class="text-muted">Tu actividad reciente aparecerá aquí</p>
                                <p class="text-muted small">Explora productos, agrega favoritos y realiza compras para ver tu actividad</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard page loaded');
    
    // Wait for common functions to be ready
    function waitForCommonFunctions() {
        return new Promise((resolve) => {
            const checkFunctions = () => {
                if (window.apiCall && window.showAlert) {
                    console.log('Common functions ready, loading dashboard data');
                    resolve();
                } else {
                    console.log('Waiting for common functions...');
                    setTimeout(checkFunctions, 100);
                }
            };
            checkFunctions();
        });
    }
    
    waitForCommonFunctions().then(() => {
        loadDashboardData();
    });
});

async function loadDashboardData() {
    try {
        console.log('Loading dashboard data...');
        
        // Load data that actually exists in the backend
        const [favoritesRes, cartRes, ordersRes] = await Promise.allSettled([
            window.apiCall('/favoritos?limit=1'), // Get count from pagination
            window.apiCall('/carrito'), // Get cart info
            window.apiCall('/ordenes?limit=1') // Get count from pagination
        ]);
        
        // Update favorites count
        if (favoritesRes.status === 'fulfilled' && favoritesRes.value.exito) {
            const count = favoritesRes.value.data?.paginacion?.total || 0;
            document.getElementById('favorites-count').textContent = count;
        } else {
            document.getElementById('favorites-count').textContent = '0';
        }
        
        // Update cart count
        if (cartRes.status === 'fulfilled' && cartRes.value.exito) {
            const count = cartRes.value.data?.total_items || 0;
            document.getElementById('cart-count').textContent = count;
        } else {
            document.getElementById('cart-count').textContent = '0';
        }
        
        // Update orders count
        if (ordersRes.status === 'fulfilled' && ordersRes.value.exito) {
            const count = ordersRes.value.data?.paginacion?.total || 0;
            document.getElementById('orders-count').textContent = count;
        } else {
            document.getElementById('orders-count').textContent = '0';
        }
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Don't show error alert for dashboard, just log it
        console.log('Dashboard data loading failed, showing default values');
        
        // Set default values
        document.getElementById('favorites-count').textContent = '0';
        document.getElementById('cart-count').textContent = '0';
        document.getElementById('orders-count').textContent = '0';
    }
}
</script> 